<script>
  (function () {
    // 仅首页
    var path = location.pathname || "/";
    var isHome = (path === "/" || path === "/index.html");
    if (!isHome) return;

    // 首次访问弹一次（可改 key 来强制再弹）
    var KEY = "wq_first_visit_modal_v1";
    if (localStorage.getItem(KEY) === "1") return;

    var modal = document.getElementById("wqModal");
    var ok = document.getElementById("wqModalOk");
    var agree = document.getElementById("wqAgree");
    var card = modal ? modal.querySelector(".wq-card") : null;

    if (!modal || !ok || !agree) return;

    // ✅ 轻微震动反馈（不改UI）
    function shake(){
      if (!card || !card.animate) return;
      card.animate(
        [
          { transform: "translateX(0)" },
          { transform: "translateX(-6px)" },
          { transform: "translateX(6px)" },
          { transform: "translateX(0)" }
        ],
        { duration: 220 }
      );
    }

    // 初始禁用 OK
    ok.disabled = true;

    function show() {
      modal.style.display = "flex";
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
      try { document.body.style.overflow = "hidden"; } catch(e){}
    }

    function hide() {
      // ✅ 必须勾选才能关闭，否则给震动反馈
      if (!agree.checked) {
        shake();
        return;
      }

      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
      try { document.body.style.overflow = ""; } catch(e){}
      setTimeout(function(){ modal.style.display = "none"; }, 180);
      localStorage.setItem(KEY, "1");
    }

    // 勾选后启用按钮
    agree.addEventListener("change", function(){
      ok.disabled = !agree.checked;
      // 可选：取消勾选时如果用户还想点，也会抖一下提示
    });

    ok.addEventListener("click", hide);

    // ✅ 点击遮罩：未勾选则抖一下；已勾选则关闭
    modal.addEventListener("click", function(e){
      if (e.target === modal) hide();
    });

    // ✅ ESC：未勾选则抖一下；已勾选则关闭
    document.addEventListener("keydown", function(e){
      if (e.key === "Escape") hide();
    });

    show();
  })();
</script>
